<script setup lang="ts">
import AddressMap from '../../map/AddressMap.vue';
import LanguageSelector from '@/components/features/layout/LanguageSelector.vue';
import { useForwardGeoSearch } from '@/composables/data/useGeoCoding';
import { useToast } from '@/composables/useToast';
import type { SubStep } from '@/types/contract/LocationWizard';
import type { LngLat } from '@/types/contract/Map';
import type { CreateLocationRequest } from '@/types/schema/Location';
import { faEdit, faHome, faMapMarkerAlt } from '@fortawesome/free-solid-svg-icons';
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome';
import Button from 'primevue/button';
import Card from 'primevue/card';
import InputText from 'primevue/inputtext';
import Textarea from 'primevue/textarea';
import { computed, nextTick, ref, watch, watchEffect } from 'vue';
import { useI18n } from 'vue-i18n';

const form = defineModel<CreateLocationRequest>({ required: true });
const complete = defineModel<boolean>('complete', { default: false });
const substeps = defineModel<SubStep[]>('substeps', { default: [] });

const toast = useToast();

const { locale } = useI18n();
const { mutateAsync: geocodeAddress, isPending: isLoading } = useForwardGeoSearch();

const currentLanguage = ref(locale.value);
const showMapDialog = ref(false);

const mapCenter = computed<LngLat>({
    get() {
        return [form.value.longitude || 0, form.value.latitude || 0] as LngLat;
    },
    set([lng, lat]: LngLat) {
        form.value.longitude = lng;
        form.value.latitude = lat;
    },
});

const currentAddress = computed(() => {
    const { street, number, city } = form.value;

    if (street && number && city) {
        return `${street} ${number}, ${city}`;
    }

    return '';
});

const canConfirmAddress = computed(() => {
    return !!(form.value.street && form.value.number && form.value.zip && form.value.city);
});

const hasCoordinates = computed(() => {
    return !!(form.value.latitude && form.value.longitude);
});

watchEffect(() => {
    const data = form.value;
    const ex = data.excerpt;
    const desc = data.description;

    complete.value = !!(
        data.name &&
        ex.nl &&
        desc.nl &&
        data.street &&
        data.number &&
        data.zip &&
        data.city &&
        hasCoordinates.value
    );
});

watchEffect(() => {
    const data = form.value;
    const ex = data.excerpt;
    const desc = data.description;

    substeps.value = [
        {
            label: 'Naam en beschrijving',
            isCompleted: !!data.name && !!ex.nl && !!desc.nl,
        },
        {
            label: 'Locatie op kaart',
            isCompleted:
                !!data.street &&
                !!data.number &&
                !!data.zip &&
                !!data.city &&
                !!hasCoordinates.value,
        },
    ];
});

const handleConfirmAddress = async () => {
    if (!canConfirmAddress.value) return;

    try {
        mapCenter.value = await geocodeAddress(currentAddress.value);
        showMapDialog.value = true;

        await nextTick();

        const mapContainer = document.getElementById('map-container');

        if (mapContainer) {
            mapContainer.scrollIntoView({
                behavior: 'smooth',
                block: 'start',
            });
        }
    } catch (error) {
        toast.add({
            severity: 'error',
            summary: 'Fout bij het ophalen van coördinaten',
            detail: 'Er is iets misgegaan bij het ophalen van de locatie. Controleer het adres en probeer het opnieuw.',
        });
    }
};
</script>

<template>
    <div class="space-y-8">
        <!-- Basic Information -->
        <div
            class="rounded-lg border-2 border-slate-200 bg-white p-6 dark:border-slate-600 dark:bg-slate-700">
            <div class="space-y-6">
                <div class="flex items-center space-x-3">
                    <div
                        class="bg-secondary-50 flex h-10 w-10 items-center justify-center rounded-full">
                        <FontAwesomeIcon :icon="faEdit" class="text-secondary-700" />
                    </div>
                    <div class="flex w-full items-center justify-between">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-slate-300">
                                Naam en beschrijving
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-slate-400">
                                Geef uw locatie een duidelijke naam en beschrijving
                            </p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <LanguageSelector v-model="currentLanguage">
                                <template #button="{ toggle, currentFlag, currentLabel }">
                                    <Button @click="toggle" severity="contrast" size="small">
                                        <img :src="currentFlag" alt="flag" class="mr-2 h-4 w-4" />
                                        <span class="text-sm">{{ currentLabel }}</span>
                                    </Button>
                                </template>
                            </LanguageSelector>
                        </div>
                    </div>
                </div>

                <!-- Name Field -->
                <div>
                    <label
                        for="name"
                        class="mb-2 block text-sm font-medium text-gray-700 dark:text-slate-200">
                        Locatie naam *
                    </label>
                    <InputText
                        id="name"
                        v-model="form.name"
                        class="w-full"
                        placeholder="Bijv. Brugs Beertje, Café Central..." />
                    <small class="mt-1 block text-gray-500 dark:text-slate-400">
                        Kies een herkenbare naam voor de locatie
                    </small>
                </div>

                <!-- Language Selector for Descriptions -->
                <div>
                    <div class="mb-4 flex items-center justify-between">
                        <label class="text-sm font-medium text-gray-700 dark:text-slate-300">
                            Korte beschrijving *
                        </label>
                    </div>

                    <div>
                        <Textarea
                            rows="3"
                            class="w-full"
                            placeholder="Bijv. Gezellig café met lokale bieren"
                            :id="`excerpt-${currentLanguage}`"
                            :maxlength="100"
                            v-model="form.excerpt![currentLanguage]">
                        </Textarea>
                        <small class="mt-1 block text-gray-500 dark:text-slate-400">
                            {{ (form.excerpt?.[currentLanguage] || '').length }}/200 karakters
                        </small>
                    </div>
                </div>

                <!-- Detailed Description -->
                <div>
                    <div class="mb-4 flex items-center justify-between">
                        <label class="text-sm font-medium text-gray-700 dark:text-slate-300">
                            Uitgebreide beschrijving *
                        </label>
                    </div>

                    <div>
                        <Textarea
                            :id="`description-${currentLanguage}`"
                            v-model="form.description![currentLanguage]"
                            class="w-full"
                            :maxlength="500"
                            rows="5"
                            placeholder="Bijv. Gezellige café met lokale bieren">
                        </Textarea>
                        <small class="mt-1 block text-gray-500 dark:text-slate-400">
                            {{ (form.description?.[currentLanguage] || '').length }}/500 karakters
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Location Details -->
        <div
            class="rounded-lg border-2 border-slate-200 bg-white p-6 dark:border-slate-600 dark:bg-slate-700">
            <div class="space-y-6">
                <div class="flex items-center space-x-3">
                    <div
                        class="bg-primary-100 flex h-10 w-10 items-center justify-center rounded-full">
                        <FontAwesomeIcon :icon="faHome" class="text-primary-600" />
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-slate-300">
                            Adres informatie
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-slate-400">
                            Voer het adres van uw locatie in
                        </p>
                    </div>
                </div>

                <!-- Manual Address Entry -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            for="street"
                            class="mb-2 block text-sm font-medium text-gray-700 dark:text-slate-300">
                            Straatnaam *
                        </label>
                        <InputText
                            id="street"
                            v-model="form.street"
                            class="w-full"
                            placeholder="Bijv. Nieuwstraat">
                        </InputText>
                    </div>

                    <div>
                        <label
                            for="number"
                            class="mb-2 block text-sm font-medium text-gray-700 dark:text-slate-300">
                            Huisnummer *
                        </label>
                        <InputText
                            id="number"
                            v-model="form.number"
                            class="w-full"
                            placeholder="Bijv. 46">
                        </InputText>
                    </div>

                    <div>
                        <label
                            for="zip"
                            class="mb-2 block text-sm font-medium text-gray-700 dark:text-slate-300">
                            Postcode *
                        </label>
                        <InputText
                            id="zip"
                            v-model="form.zip"
                            class="w-full"
                            placeholder="Bijv. 8610">
                        </InputText>
                    </div>

                    <div>
                        <label
                            for="city"
                            class="mb-2 block text-sm font-medium text-gray-700 dark:text-slate-300">
                            Stad *
                        </label>
                        <InputText
                            id="city"
                            v-model="form.city"
                            class="w-full"
                            placeholder="Bijv. Kortemark">
                        </InputText>
                    </div>
                </div>

                <!-- Address Confirmation Button -->
                <div
                    class="flex items-center justify-between rounded-lg border-2 border-slate-200 bg-gray-50 p-4 dark:border-slate-600 dark:bg-slate-700">
                    <div>
                        <h4 class="font-medium text-gray-900 dark:text-slate-100">
                            Bevestig locatie op kaart
                        </h4>
                        <p class="text-sm text-gray-600 dark:text-slate-400">
                            Controleer en bevestig de exacte locatie op de kaart
                        </p>
                        <div
                            v-if="hasCoordinates"
                            class="text-primary-600 dark:text-primary-400 mt-1 text-xs">
                            ✓ Bevestigd:
                            {{ form.latitude?.toFixed(6) }},
                            {{ form.longitude?.toFixed(6) }}
                        </div>
                    </div>
                    <Button
                        @click="handleConfirmAddress"
                        :disabled="!canConfirmAddress"
                        :loading="isLoading"
                        :outlined="!hasCoordinates">
                        <FontAwesomeIcon :icon="faMapMarkerAlt" class="mr-2" />
                        Bevestig op kaart
                    </Button>
                </div>
                <template v-if="showMapDialog">
                    <div class="h-[400px] w-full" id="map-container">
                        <AddressMap v-model:center="mapCenter" :zoom="18"> </AddressMap>
                    </div>
                </template>
            </div>
        </div>
    </div>
</template>
